<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Amazonq2api å‰ç«¯æ§åˆ¶å° Â· è´¦å·ç®¡ç† + Chat æµ‹è¯•</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#0f1420;
      --muted:#8b95a8;
      --text:#e8f0ff;
      --accent:#4f8fff;
      --danger:#ff4757;
      --ok:#2ed573;
      --warn:#ffa502;
      --border:#1a2332;
      --chip:#141b28;
      --code:#0d1218;
      --glow:rgba(79,143,255,.15);
    }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    body {
      padding:0 0 40px;
      background:radial-gradient(ellipse at top, #0f1624 0%, #0a0e1a 100%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Noto Sans,Arial,sans-serif;
      line-height:1.6;
    }
    h1,h2,h3 { font-weight:700; letter-spacing:-.02em; margin:0; }
    h1 { font-size:28px; margin:24px 0 12px; background:linear-gradient(135deg,#4f8fff,#7b9fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    h2 { font-size:18px; margin:20px 0 16px; color:#c5d4ff; }
    h3 { font-size:15px; margin:16px 0 10px; color:#a8b8d8; }
    .container { max-width:1280px; margin:0 auto; padding:20px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media(max-width:1024px){ .grid { grid-template-columns:1fr; } }
    .panel {
      background:linear-gradient(145deg,rgba(15,20,32,.8),rgba(10,14,26,.9));
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.4),0 0 0 1px rgba(79,143,255,.08),inset 0 1px 0 rgba(255,255,255,.03);
      backdrop-filter:blur(12px);
      transition:transform .2s,box-shadow .2s;
    }
    .panel:hover { transform:translateY(-2px); box-shadow:0 24px 70px rgba(0,0,0,.5),0 0 0 1px rgba(79,143,255,.12),inset 0 1px 0 rgba(255,255,255,.04); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { color:var(--muted); font-size:13px; font-weight:500; letter-spacing:.01em; }
    .field { display:flex; flex-direction:column; gap:8px; flex:1; min-width:200px; }
    input,textarea,select {
      background:rgba(12,16,28,.6);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      outline:none;
      transition:all .2s;
      font-size:14px;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.2);
    }
    input:focus,textarea:focus,select:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--glow),inset 0 1px 2px rgba(0,0,0,.2);
      background:rgba(12,16,28,.8);
    }
    textarea { min-height:140px; resize:vertical; font-family:ui-monospace,monospace; }
    button {
      background:linear-gradient(135deg,#2563eb,#1e40af);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:all .2s;
      box-shadow:0 4px 16px rgba(37,99,235,.3),inset 0 1px 0 rgba(255,255,255,.1);
      position:relative;
      overflow:hidden;
    }
    button:before {
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);
      opacity:0;
      transition:opacity .2s;
    }
    button:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(37,99,235,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    button:hover:before { opacity:1; }
    button:active { transform:translateY(0); }
    button:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .btn-secondary { background:linear-gradient(135deg,#1e293b,#0f172a); box-shadow:0 4px 16px rgba(15,23,42,.3),inset 0 1px 0 rgba(255,255,255,.05); }
    .btn-secondary:hover { box-shadow:0 6px 20px rgba(15,23,42,.4),inset 0 1px 0 rgba(255,255,255,.08); }
    .btn-danger { background:linear-gradient(135deg,#dc2626,#991b1b); box-shadow:0 4px 16px rgba(220,38,38,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-danger:hover { box-shadow:0 6px 20px rgba(220,38,38,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .btn-warn { background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 16px rgba(245,158,11,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-warn:hover { box-shadow:0 6px 20px rgba(245,158,11,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .kvs { display:grid; grid-template-columns:160px 1fr; gap:10px 16px; font-size:13px; }
    .muted { color:var(--muted); }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:rgba(20,27,40,.8);
      border:1px solid var(--border);
      border-radius:20px;
      color:#a8b8ff;
      font-size:12px;
      font-weight:500;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .list { position:relative; max-height:600px; overflow:auto; padding:2px; }
    .list::-webkit-scrollbar { width:8px; }
    .list::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .list::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .list::-webkit-scrollbar-thumb:hover { background:rgba(79,143,255,.5); }
    .list-viewport { position:relative; }
    .list-content { display:flex; flex-direction:column; gap:12px; }
    .card {
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      background:linear-gradient(145deg,rgba(12,19,34,.6),rgba(10,14,26,.8));
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.02);
      transition:all .2s;
    }
    .card:hover { border-color:rgba(79,143,255,.3); box-shadow:0 6px 20px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.03); }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .code {
      background:var(--code);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      color:#d8e8ff;
      max-height:300px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.6;
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .code::-webkit-scrollbar { width:8px; height:8px; }
    .code::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .code::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .right { margin-left:auto; }
    .sep { height:1px; background:linear-gradient(90deg,transparent,rgba(79,143,255,.2),transparent); margin:16px 0; }
    .status-ok { color:var(--ok); font-weight:600; }
    .status-fail { color:var(--danger); font-weight:600; }
    .switch { position:relative; display:inline-block; width:50px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute;
      cursor:pointer;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,#374151,#1f2937);
      transition:.3s;
      border-radius:26px;
      border:1px solid var(--border);
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .slider:before {
      position:absolute;
      content:"";
      height:20px;
      width:20px;
      left:3px;
      bottom:2px;
      background:linear-gradient(135deg,#f3f4f6,#e5e7eb);
      transition:.3s;
      border-radius:50%;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }
    input:checked+.slider { background:linear-gradient(135deg,#3b82f6,#2563eb); box-shadow:0 0 12px rgba(59,130,246,.4),inset 0 2px 4px rgba(0,0,0,.2); }
    input:checked+.slider:before { transform:translateX(24px); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .panel { animation:fadeIn .4s ease-out; }
    .tabs { display:flex; gap:8px; margin:20px 0 16px; border-bottom:2px solid var(--border); }
    .tab { padding:12px 24px; background:transparent; border:none; color:var(--muted); font-weight:600; font-size:14px; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .2s; }
    .tab:hover { color:var(--text); background:rgba(79,143,255,.05); }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Q2api å‰ç«¯æ§åˆ¶å°</h1>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('accounts')">è´¦å·ç®¡ç†</button>
      <button class="tab" onclick="switchTab('create')">åˆ›å»ºè´¦å·</button>
      <button class="tab" onclick="switchTab('login')">URLç™»å½•</button>
      <button class="tab" onclick="switchTab('chat')">Chatæµ‹è¯•</button>
    </div>

    <div id="tab-accounts" class="tab-content active">
      <div class="panel">
        <h2>è´¦å·ç®¡ç† <span id="accountCount" style="font-size: 0.8em; color: #666;"></span></h2>
        <div class="row">
          <button class="btn-secondary" onclick="loadAccounts()">åˆ·æ–°åˆ—è¡¨</button>
          <button class="btn-secondary" onclick="queryUsage()" id="usageBtn">æŸ¥è¯¢å¯ç”¨æ€»ä½¿ç”¨é‡</button>
          <div style="margin-left: 20px;">
            <label><input type="radio" name="accountFilter" value="all" checked onchange="loadAccounts()"> å…¨éƒ¨</label>
            <label style="margin-left: 10px;"><input type="radio" name="accountFilter" value="enabled" onchange="loadAccounts()"> å·²å¯ç”¨</label>
            <label style="margin-left: 10px;"><input type="radio" name="accountFilter" value="disabled" onchange="loadAccounts()"> å·²ç¦ç”¨</label>
          </div>
          <div style="margin-left: 20px;">
            <label>æ’åºï¼š
              <select id="sortBy" onchange="loadAccounts()">
                <option value="created_at">åˆ›å»ºæ—¥æœŸ</option>
                <option value="success_count">æˆåŠŸæ¬¡æ•°</option>
              </select>
            </label>
            <label style="margin-left: 10px;">
              <select id="sortOrder" onchange="loadAccounts()">
                <option value="desc">é™åº</option>
                <option value="asc">å‡åº</option>
              </select>
            </label>
          </div>
        </div>
        <div class="list" id="accounts"></div>
      </div>
    </div>

    <div id="tab-create" class="tab-content">
      <div class="panel">
        <h2>åˆ›å»ºè´¦å·</h2>
        <div class="row">
          <div class="field"><label>label</label><input id="new_label" /></div>
          <div class="field"><label>clientId</label><input id="new_clientId" /></div>
          <div class="field"><label>clientSecret</label><input id="new_clientSecret" /></div>
        </div>
        <div class="row">
          <div class="field"><label>refreshToken</label><input id="new_refreshToken" /></div>
          <div class="field"><label>accessToken</label><input id="new_accessToken" /></div>
        </div>
        <div class="row">
          <div class="field">
            <label>otherï¼ˆJSONï¼Œå¯é€‰ï¼‰</label>
            <textarea id="new_other" placeholder='{"note":"å¤‡æ³¨"}'></textarea>
          </div>
          <div class="field" style="max-width:220px">
            <label>å¯ç”¨ï¼ˆä»…å¯ç”¨è´¦å·ä¼šè¢«ç”¨äºè¯·æ±‚ï¼‰</label>
            <div>
              <label class="switch">
                <input id="new_enabled" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <button onclick="createAccount()">åˆ›å»º</button>
        </div>
      </div>
    </div>

    <div id="tab-login" class="tab-content">
      <div class="panel">
        <h2>URL ç™»å½•ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰</h2>
        <div class="row">
          <div class="field"><label>labelï¼ˆå¯é€‰ï¼‰</label><input id="auth_label" /></div>
          <div class="field" style="max-width:220px">
            <label>å¯ç”¨ï¼ˆç™»å½•æˆåŠŸåæ–°è´¦å·æ˜¯å¦å¯ç”¨ï¼‰</label>
            <div>
              <label class="switch">
                <input id="auth_enabled" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <button onclick="startAuth()">å¼€å§‹ç™»å½•</button>
          <button class="btn-secondary" onclick="claimAuth()">ç­‰å¾…æˆæƒå¹¶åˆ›å»ºè´¦å·</button>
        </div>
        <div class="field">
          <label>ç™»å½•ä¿¡æ¯</label>
          <pre class="code mono" id="auth_info">å°šæœªå¼€å§‹</pre>
        </div>
      </div>
    </div>

    <div id="tab-chat" class="tab-content">
      <div class="panel">
        <h2>Chat æµ‹è¯•ï¼ˆOpenAI å…¼å®¹ /v1/chat/completionsï¼‰</h2>
        <div class="row">
          <div class="field" style="max-width:300px">
            <label>model</label>
            <input id="model" value="claude-sonnet-4" />
          </div>
          <div class="field" style="max-width:180px">
            <label>æ˜¯å¦æµå¼</label>
            <select id="stream">
              <option value="false">falseï¼ˆé»˜è®¤ï¼‰</option>
              <option value="true">trueï¼ˆSSEï¼‰</option>
            </select>
          </div>
          <button class="right" onclick="send()">å‘é€è¯·æ±‚</button>
        </div>
        <div class="field">
          <label>messagesï¼ˆJSONï¼‰</label>
          <textarea id="messages">[
  {"role":"system","content":"ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹"},
  {"role":"user","content":"ä½ å¥½ï¼Œè¯·è®²ä¸€ä¸ªç®€çŸ­çš„æ•…äº‹"}
]</textarea>
        </div>
        <div class="field">
          <label>å“åº”</label>
          <pre class="code mono" id="out"></pre>
        </div>
      </div>
    </div>
  </div>


<script>
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function api(path){
  const pathClean = ('/' + (path || '').replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
  return pathClean;
}

// Authentication helpers
function getAuthPassword() {
  return localStorage.getItem('adminPassword');
}

function getAuthHeaders() {
  const password = getAuthPassword();
  if (!password) return {};
  return { 'Authorization': `Bearer ${password}` };
}

// Authenticated fetch wrapper
async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...options.headers };
  const response = await fetch(url, { ...options, headers });

  if (response.status === 401) {
    localStorage.removeItem('adminPassword');
    window.location.href = '/login';
    throw new Error('Unauthorized');
  }

  return response;
}

// Check authentication on page load - removed, combined with loadAccounts below

// Virtual scroll state
let accountsData = [];
let virtualScroll = null;

// Create account card element
function createAccountCard(acc) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.accountId = acc.id;

  const header = document.createElement('div');
  header.className = 'row';
  const name = document.createElement('div');
  name.innerHTML = '<strong>' + (acc.label || '(æ— æ ‡ç­¾)') + '</strong>';
  const id = document.createElement('div');
  id.className = 'chip mono';
  id.textContent = acc.id;

  const spacer = document.createElement('div');
  spacer.className = 'right';

  // Enabled toggle
  const toggleWrap = document.createElement('div');
  const toggleLabel = document.createElement('label');
  toggleLabel.style.marginRight = '6px';
  toggleLabel.className = 'muted';
  toggleLabel.textContent = 'å¯ç”¨';
  const toggle = document.createElement('label');
  toggle.className = 'switch';
  const chk = document.createElement('input');
  chk.type = 'checkbox';
  chk.checked = !!acc.enabled;
  chk.onchange = async () => {
    try {
      await updateAccount(acc.id, { enabled: chk.checked });
    } catch(e) {
      chk.checked = !chk.checked;
    }
  };
  const slider = document.createElement('span');
  slider.className = 'slider';
  toggle.appendChild(chk); toggle.appendChild(slider);
  toggleWrap.appendChild(toggleLabel); toggleWrap.appendChild(toggle);

  const usageBtn = document.createElement('button');
  usageBtn.className = 'btn-secondary';
  usageBtn.textContent = 'æŸ¥è¯¢ç”¨é‡';
  usageBtn.onclick = () => querySingleUsage(acc.id, acc.label);

  const refreshBtn = document.createElement('button');
  refreshBtn.className = 'btn-warn';
  refreshBtn.textContent = 'åˆ·æ–°Token';
  refreshBtn.onclick = () => refreshAccount(acc.id);

  const delBtn = document.createElement('button');
  delBtn.className = 'btn-danger';
  delBtn.textContent = 'åˆ é™¤';
  delBtn.onclick = () => deleteAccount(acc.id);

  header.appendChild(name);
  header.appendChild(id);
  header.appendChild(spacer);
  header.appendChild(toggleWrap);
  header.appendChild(usageBtn);
  header.appendChild(refreshBtn);
  header.appendChild(delBtn);
  card.appendChild(header);

  const meta = document.createElement('div');
  meta.className = 'kvs mono';
  function row(k, v) {
    const kEl = document.createElement('div'); kEl.className = 'muted'; kEl.textContent = k;
    const vEl = document.createElement('div'); vEl.textContent = v ?? '';
    meta.appendChild(kEl); meta.appendChild(vEl);
  }
  row('enabled', String(!!acc.enabled));
  row('success_count', acc.success_count ?? 0);
  row('error_count', acc.error_count ?? 0);
  row('last_refresh_status', acc.last_refresh_status);
  row('last_refresh_time', acc.last_refresh_time);
  row('clientId', acc.clientId);
  row('hasRefreshToken', acc.refreshToken ? 'yes' : 'no');
  row('hasAccessToken', acc.accessToken ? 'yes' : 'no');
  row('created_at', acc.created_at);
  row('updated_at', acc.updated_at);
  if (acc.other) {
    row('other', JSON.stringify(acc.other));
  }
  card.appendChild(meta);

  // quick edit form
  const editRow = document.createElement('div');
  editRow.className = 'row';
  editRow.style.marginTop = '8px';
  const labelField = document.createElement('input');
  labelField.placeholder = 'label';
  labelField.value = acc.label || '';
  const accessField = document.createElement('input');
  accessField.placeholder = 'accessTokenï¼ˆå¯é€‰ï¼‰';
  accessField.value = acc.accessToken || '';
  const saveBtn = document.createElement('button');
  saveBtn.className = 'btn-secondary';
  saveBtn.textContent = 'ä¿å­˜';
  saveBtn.onclick = async () => {
    await updateAccount(acc.id, { label: labelField.value, accessToken: accessField.value });
  };
  editRow.appendChild(labelField);
  editRow.appendChild(accessField);
  editRow.appendChild(saveBtn);
  card.appendChild(editRow);

  return card;
}

// Virtual scroll implementation with auto height adjustment
class VirtualScroll {
  constructor(container, items, itemHeight, bufferSize = 3) {
    this.container = container;
    this.items = items;
    this.itemHeight = itemHeight;
    this.bufferSize = bufferSize;
    this.visibleStart = 0;
    this.visibleEnd = 0;
    this.renderedItems = new Map();
    this.measuredHeights = new Map();
    this.heightAdjusted = false;
    
    this.viewport = document.createElement('div');
    this.viewport.className = 'list-viewport';
    this.content = document.createElement('div');
    this.content.className = 'list-content';
    this.viewport.appendChild(this.content);
    
    this.container.innerHTML = '';
    this.container.appendChild(this.viewport);
    
    this.container.addEventListener('scroll', () => this.onScroll());
    this.render();
    
    // Auto-measure after first render
    requestAnimationFrame(() => this.measureAndAdjust());
  }
  
  onScroll() {
    requestAnimationFrame(() => this.render());
  }
  
  measureAndAdjust() {
    let maxHeight = 0;
    let needsAdjustment = false;
    
    // Measure all currently rendered items
    for (const [idx, element] of this.renderedItems.entries()) {
      const rect = element.getBoundingClientRect();
      const actualHeight = rect.height + 12; // +12 for gap
      this.measuredHeights.set(idx, actualHeight);
      
      if (actualHeight > maxHeight) {
        maxHeight = actualHeight;
      }
      
      // Check if actual height exceeds estimated height
      if (actualHeight > this.itemHeight * 0.95) {
        needsAdjustment = true;
      }
    }
    
    // Auto-adjust if needed
    if (needsAdjustment && maxHeight > this.itemHeight) {
      console.log(`[VirtualScroll] æ£€æµ‹åˆ°é‡å½±ï¼Œè°ƒæ•´é«˜åº¦: ${this.itemHeight}px -> ${Math.ceil(maxHeight)}px`);
      this.itemHeight = Math.ceil(maxHeight);
      this.heightAdjusted = true;
      
      // Re-render with new height
      this.reposition();
    }
  }
  
  reposition() {
    // Reposition all rendered items with new height
    for (const [idx, element] of this.renderedItems.entries()) {
      element.style.top = (idx * this.itemHeight) + 'px';
    }
    
    // Update viewport height
    this.viewport.style.height = (this.items.length * this.itemHeight) + 'px';
  }
  
  render() {
    const scrollTop = this.container.scrollTop;
    const containerHeight = this.container.clientHeight;
    
    const start = Math.floor(scrollTop / this.itemHeight);
    const end = Math.ceil((scrollTop + containerHeight) / this.itemHeight);
    
    const bufferedStart = Math.max(0, start - this.bufferSize);
    const bufferedEnd = Math.min(this.items.length, end + this.bufferSize);
    
    if (bufferedStart === this.visibleStart && bufferedEnd === this.visibleEnd) {
      return;
    }
    
    this.visibleStart = bufferedStart;
    this.visibleEnd = bufferedEnd;
    
    // Set viewport height
    this.viewport.style.height = (this.items.length * this.itemHeight) + 'px';
    
    // Remove items outside visible range
    for (const [idx, element] of this.renderedItems.entries()) {
      if (idx < bufferedStart || idx >= bufferedEnd) {
        element.remove();
        this.renderedItems.delete(idx);
      }
    }
    
    // Add items in visible range
    const fragment = document.createDocumentFragment();
    let newItemsAdded = false;
    
    for (let i = bufferedStart; i < bufferedEnd; i++) {
      if (!this.renderedItems.has(i)) {
        const item = createAccountCard(this.items[i]);
        item.style.position = 'absolute';
        item.style.top = (i * this.itemHeight) + 'px';
        item.style.left = '0';
        item.style.right = '0';
        this.renderedItems.set(i, item);
        fragment.appendChild(item);
        newItemsAdded = true;
      }
    }
    
    if (fragment.childNodes.length > 0) {
      this.content.appendChild(fragment);
      
      // Measure new items after they're added to DOM
      if (newItemsAdded && !this.heightAdjusted) {
        requestAnimationFrame(() => this.measureAndAdjust());
      }
    }
  }
  
  update(items) {
    this.items = items;
    this.renderedItems.clear();
    this.measuredHeights.clear();
    this.heightAdjusted = false;
    this.content.innerHTML = '';
    this.visibleStart = -1; // Force re-render
    this.visibleEnd = -1;
    requestAnimationFrame(() => {
      this.render();
      this.measureAndAdjust();
    });
  }
  
  destroy() {
    this.container.removeEventListener('scroll', this.onScroll);
    this.renderedItems.clear();
    this.measuredHeights.clear();
  }
}

function renderAccounts(list){
  accountsData = list;
  const root = document.getElementById('accounts');
  
  if (!Array.isArray(list) || list.length === 0) {
    if (virtualScroll) {
      virtualScroll.destroy();
      virtualScroll = null;
    }
    root.innerHTML = '';
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'æš‚æ— è´¦å·';
    root.appendChild(empty);
    return;
  }
  
  // Estimate item height (card height ~280px with gap)
  const estimatedItemHeight = 292;
  
  if (virtualScroll) {
    virtualScroll.update(list);
  } else {
    virtualScroll = new VirtualScroll(root, list, estimatedItemHeight);
  }
}

async function loadAccounts(){
  try{
    const filter = document.querySelector('input[name="accountFilter"]:checked')?.value || 'all';
    const sortBy = document.getElementById('sortBy')?.value || 'created_at';
    const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
    let url = '/v2/accounts?';
    const params = [];
    if (filter === 'enabled') params.push('enabled=true');
    else if (filter === 'disabled') params.push('enabled=false');
    params.push(`sort_by=${sortBy}`);
    params.push(`sort_order=${sortOrder}`);
    url += params.join('&');
    const r = await authFetch(api(url));
    const j = await r.json();
    document.getElementById('accountCount').textContent = `(${j.count})`;
    renderAccounts(j.accounts);
  } catch(e){
    alert('åŠ è½½è´¦æˆ·å¤±è´¥ï¼š' + e);
  }
}

async function createAccount(){
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').checked,
    other: (()=>{
      const t = document.getElementById('new_other').value.trim();
      if (!t) return null;
      try { return JSON.parse(t); } catch { alert('other ä¸æ˜¯åˆæ³• JSON'); throw new Error('bad other'); }
    })()
  };
  try{
    const r = await authFetch(api('/v2/accounts'), {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(t);
    }
    await loadAccounts();
  } catch(e){
    alert('åˆ›å»ºå¤±è´¥ï¼š' + e);
  }
}

async function deleteAccount(id){
  if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è´¦å·ï¼Ÿ')) return;
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), { method:'DELETE' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('åˆ é™¤å¤±è´¥ï¼š' + e);
  }
}

async function updateAccount(id, patch){
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), {
      method:'PATCH',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(patch)
    });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('æ›´æ–°å¤±è´¥ï¼š' + e);
  }
}

async function refreshAccount(id){
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id) + '/refresh'), { method:'POST' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('åˆ·æ–°å¤±è´¥ï¼š' + e);
  }
}

// ä½¿ç”¨é‡æŸ¥è¯¢
let usageModal = null;

// å•ä¸ªè´¦å·ä½¿ç”¨é‡æŸ¥è¯¢
async function querySingleUsage(accountId, label) {
  try {
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(accountId) + '/usage'));
    if (!r.ok) { throw new Error(await r.text()); }
    const data = await r.json();
    // åŒ…è£…æˆä¸æ‰¹é‡æŸ¥è¯¢ç›¸åŒçš„æ ¼å¼
    showUsageModal({
      results: [data],
      total: 1,
      success_count: data.success ? 1 : 0
    });
  } catch(e) {
    alert('æŸ¥è¯¢ä½¿ç”¨é‡å¤±è´¥ï¼š' + e);
  }
}

async function queryUsage(){
  const btn = document.getElementById('usageBtn');
  btn.disabled = true;
  btn.textContent = 'æŸ¥è¯¢ä¸­...';
  try {
    const r = await authFetch(api('/v2/accounts/usage'));
    if (!r.ok) { throw new Error(await r.text()); }
    const data = await r.json();
    showUsageModal(data);
  } catch(e) {
    alert('æŸ¥è¯¢ä½¿ç”¨é‡å¤±è´¥ï¼š' + e);
  } finally {
    btn.disabled = false;
    btn.textContent = 'æŸ¥è¯¢å¯ç”¨æ€»ä½¿ç”¨é‡';
  }
}

function showUsageModal(data) {
  if (usageModal) usageModal.remove();

  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;';

  // è®¡ç®—æ±‡æ€»ç»Ÿè®¡
  let totalCreditUsed = 0, totalCreditLimit = 0;
  let totalFreeTrialUsed = 0, totalFreeTrialLimit = 0;
  let hasMultipleAccounts = data.total > 1;

  if (data.results && data.results.length > 0) {
    for (const r of data.results) {
      if (r.success && r.usage && r.usage.usageBreakdownList) {
        for (const b of r.usage.usageBreakdownList) {
          // æ±‡æ€» Credit ä½¿ç”¨é‡
          const used = b.currentUsageWithPrecision ?? b.currentUsage ?? 0;
          const limit = b.usageLimitWithPrecision ?? b.usageLimit ?? 0;
          totalCreditUsed += used;
          totalCreditLimit += limit;
          // æ±‡æ€»å…è´¹è¯•ç”¨
          if (b.freeTrialInfo && b.freeTrialInfo.usageLimit > 0) {
            const ft = b.freeTrialInfo;
            const ftUsed = ft.currentUsageWithPrecision ?? ft.currentUsage ?? 0;
            const ftLimit = ft.usageLimitWithPrecision ?? ft.usageLimit ?? 0;
            totalFreeTrialUsed += ftUsed;
            totalFreeTrialLimit += ftLimit;
          }
        }
      }
    }
  }

  const totalCreditPct = totalCreditLimit > 0 ? Math.round(totalCreditUsed / totalCreditLimit * 100) : 0;
  const totalCreditColor = totalCreditPct > 80 ? 'var(--danger)' : totalCreditPct > 50 ? 'var(--warn)' : 'var(--ok)';
  const totalFreeTrialPct = totalFreeTrialLimit > 0 ? Math.round(totalFreeTrialUsed / totalFreeTrialLimit * 100) : 0;
  const totalFreeTrialColor = totalFreeTrialPct > 80 ? 'var(--danger)' : totalFreeTrialPct > 50 ? 'var(--warn)' : 'var(--ok)';

  let html = `<div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:800px;max-height:80vh;overflow:auto;min-width:400px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2 style="margin:0;color:#c5d4ff;">ä½¿ç”¨é‡æŸ¥è¯¢ç»“æœ</h2>
      <button onclick="if(usageModal){usageModal.remove();usageModal=null;}" style="background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer;">&times;</button>
    </div>
    <div style="color:var(--muted);margin-bottom:16px;">æˆåŠŸ: ${data.success_count}/${data.total}</div>`;

  // æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡ï¼ˆä»…å½“æœ‰å¤šä¸ªè´¦å·æ—¶æ˜¾ç¤ºï¼‰
  if (hasMultipleAccounts && totalCreditLimit > 0) {
    html += `<div style="border:2px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:20px;background:rgba(79,143,255,0.1);">
      <h3 style="margin:0 0 12px 0;color:var(--accent);font-size:16px;">å¯ç”¨è´¦å·æ€»ä½¿ç”¨é‡æ±‡æ€»</h3>
      <div style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--text);margin-bottom:4px;">
          <span>Credit æ€»ä½¿ç”¨é‡</span>
          <span>${totalCreditUsed.toFixed(2)}/${totalCreditLimit.toFixed(2)} (${totalCreditPct}%)</span>
        </div>
        <div style="background:var(--border);border-radius:6px;height:10px;">
          <div style="background:${totalCreditColor};height:100%;border-radius:6px;width:${totalCreditPct}%;transition:width 0.3s;"></div>
        </div>
      </div>`;

    if (totalFreeTrialLimit > 0) {
      html += `<div>
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--text);margin-bottom:4px;">
          <span>å…è´¹è¯•ç”¨æ€»ä½¿ç”¨é‡</span>
          <span>${totalFreeTrialUsed.toFixed(2)}/${totalFreeTrialLimit.toFixed(2)} (${totalFreeTrialPct}%)</span>
        </div>
        <div style="background:var(--border);border-radius:6px;height:10px;">
          <div style="background:${totalFreeTrialColor};height:100%;border-radius:6px;width:${totalFreeTrialPct}%;transition:width 0.3s;"></div>
        </div>
      </div>`;
    }
    html += `</div>`;
  }

  if (data.results && data.results.length > 0) {
    for (const r of data.results) {
      const label = r.label || r.account_id.slice(0,8);
      const statusColor = r.success ? 'var(--ok)' : 'var(--danger)';
      html += `<div style="border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px;background:rgba(12,19,34,0.6);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-weight:600;color:var(--text);">${label}</span>
          <span style="color:${statusColor};font-size:12px;">${r.success ? 'æˆåŠŸ' : r.error || 'å¤±è´¥'}</span>
        </div>`;

      if (r.success && r.usage) {
        const u = r.usage;
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        if (u.userInfo?.email) {
          html += `<div style="color:var(--muted);font-size:12px;margin-top:8px;">é‚®ç®±: ${u.userInfo.email}</div>`;
        }
        // æ˜¾ç¤ºè®¢é˜…ä¿¡æ¯
        if (u.subscriptionInfo?.subscriptionTitle) {
          html += `<div style="color:var(--accent);font-size:12px;">è®¢é˜…: ${u.subscriptionInfo.subscriptionTitle}</div>`;
        }
        // æ˜¾ç¤ºä½¿ç”¨é‡æ˜ç»†
        if (u.usageBreakdownList && u.usageBreakdownList.length > 0) {
          for (const b of u.usageBreakdownList) {
            const used = b.currentUsageWithPrecision ?? b.currentUsage ?? 0;
            const limit = b.usageLimitWithPrecision ?? b.usageLimit ?? 0;
            const pct = limit > 0 ? Math.round(used / limit * 100) : 0;
            const barColor = pct > 80 ? 'var(--danger)' : pct > 50 ? 'var(--warn)' : 'var(--ok)';
            // æ ¼å¼åŒ–é‡ç½®æ—¶é—´
            let resetTimeStr = '';
            if (b.nextDateReset) {
              const resetDate = new Date(b.nextDateReset * 1000);
              resetTimeStr = resetDate.toLocaleString('zh-CN', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
            }
            html += `<div style="margin-top:8px;">
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text);">
                <span>${b.displayName || b.resourceType}</span>
                <span>${used}/${limit} (${pct}%)${resetTimeStr ? ' é‡ç½®:'+resetTimeStr : ''}</span>
              </div>
              <div style="background:var(--border);border-radius:4px;height:6px;margin-top:4px;">
                <div style="background:${barColor};height:100%;border-radius:4px;width:${pct}%;"></div>
              </div>
            </div>`;
            // æ˜¾ç¤ºèµ é€ç§¯åˆ†(bonuses)
            if (b.bonuses && b.bonuses.length > 0) {
              for (const bonus of b.bonuses) {
                const bUsed = bonus.currentUsage ?? 0;
                const bLimit = bonus.usageLimit ?? 0;
                const bPct = bLimit > 0 ? Math.round(bUsed / bLimit * 100) : 0;
                const bColor = bPct > 80 ? 'var(--danger)' : bPct > 50 ? 'var(--warn)' : 'var(--ok)';
                let expireStr = '';
                if (bonus.expiresAt) {
                  const expDate = new Date(bonus.expiresAt * 1000);
                  expireStr = expDate.toLocaleString('zh-CN', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
                }
                html += `<div style="margin-top:6px;margin-left:12px;padding:6px;background:rgba(99,102,241,0.1);border-radius:6px;">
                  <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--accent);">
                    <span>ğŸ ${bonus.displayName || bonus.bonusCode || 'èµ é€'}</span>
                    <span>${bUsed}/${bLimit}${expireStr ? ' è¿‡æœŸ:'+expireStr : ''}</span>
                  </div>
                  <div style="background:var(--border);border-radius:3px;height:4px;margin-top:3px;">
                    <div style="background:${bColor};height:100%;border-radius:3px;width:${bPct}%;"></div>
                  </div>
                </div>`;
              }
            }
            // æ˜¾ç¤ºå…è´¹è¯•ç”¨
            if (b.freeTrialInfo && b.freeTrialInfo.usageLimit > 0) {
              const ft = b.freeTrialInfo;
              const ftUsed = ft.currentUsageWithPrecision ?? ft.currentUsage ?? 0;
              const ftLimit = ft.usageLimitWithPrecision ?? ft.usageLimit ?? 0;
              const ftPct = ftLimit > 0 ? Math.round(ftUsed / ftLimit * 100) : 0;
              const ftColor = ftPct > 80 ? 'var(--danger)' : ftPct > 50 ? 'var(--warn)' : 'var(--ok)';
              let ftExpire = '';
              if (ft.freeTrialExpiry) {
                const ftDate = new Date(ft.freeTrialExpiry * 1000);
                ftExpire = ftDate.toLocaleString('zh-CN', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
              }
              html += `<div style="margin-top:8px;">
                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text);">
                  <span>ğŸ†“ å…è´¹è¯•ç”¨ (${ft.freeTrialStatus || ''})</span>
                  <span>${ftUsed}/${ftLimit} (${ftPct}%)${ftExpire ? ' è¿‡æœŸ:'+ftExpire : ''}</span>
                </div>
                <div style="background:var(--border);border-radius:4px;height:6px;margin-top:4px;">
                  <div style="background:${ftColor};height:100%;border-radius:4px;width:${ftPct}%;"></div>
                </div>
              </div>`;
            }
          }
        }
      }
      html += '</div>';
    }
  } else {
    html += '<div style="color:var(--muted);">æš‚æ— æ•°æ®</div>';
  }

  html += '</div>';
  modal.innerHTML = html;
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
  usageModal = modal;
}

 // URL Login (Device Authorization)
 let currentAuth = null;
 async function startAuth(){
   const body = {
     label: (document.getElementById('auth_label').value || '').trim() || null,
     enabled: document.getElementById('auth_enabled').checked
   };
   try {
     const r = await authFetch(api('/v2/auth/start'), {
       method: 'POST',
       headers: { 'content-type': 'application/json' },
       body: JSON.stringify(body)
     });
     if (!r.ok) throw new Error(await r.text());
     const j = await r.json();
     currentAuth = j;
     const info = [
       'éªŒè¯é“¾æ¥: ' + j.verificationUriComplete,
       'ç”¨æˆ·ä»£ç : ' + (j.userCode || ''),
       'authId: ' + j.authId,
       'expiresIn: ' + j.expiresIn + 's',
       'interval: ' + j.interval + 's'
     ].join('\\n');
     const el = document.getElementById('auth_info');
     el.textContent = info + '\\n\\nè¯·åœ¨æ–°çª—å£ä¸­æ‰“å¼€ä¸Šè¿°é“¾æ¥å®Œæˆç™»å½•ã€‚';
     try { window.open(j.verificationUriComplete, '_blank'); } catch {}
   } catch(e){
     document.getElementById('auth_info').textContent = 'å¯åŠ¨å¤±è´¥ï¼š' + e;
   }
 }

 async function claimAuth(){
   if (!currentAuth || !currentAuth.authId) {
     document.getElementById('auth_info').textContent = 'è¯·å…ˆç‚¹å‡»â€œå¼€å§‹ç™»å½•â€ã€‚';
     return;
   }
   document.getElementById('auth_info').textContent += '\\n\\næ­£åœ¨ç­‰å¾…æˆæƒå¹¶åˆ›å»ºè´¦å·ï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰...';
   try{
     const r = await authFetch(api('/v2/auth/claim/' + encodeURIComponent(currentAuth.authId)), { method: 'POST' });
     const text = await r.text();
     let j;
     try { j = JSON.parse(text); } catch { j = { raw: text }; }
     document.getElementById('auth_info').textContent = 'å®Œæˆï¼š\\n' + JSON.stringify(j, null, 2);
     await loadAccounts();
   } catch(e){
     document.getElementById('auth_info').textContent += '\\nå¤±è´¥ï¼š' + e;
   }
 }

async function send() {
  const model = document.getElementById('model').value.trim();
  const stream = document.getElementById('stream').value === 'true';
  const out = document.getElementById('out');
  out.textContent = '';

  let messages;
  try { messages = JSON.parse(document.getElementById('messages').value); }
  catch(e){ out.textContent = 'messages ä¸æ˜¯åˆæ³• JSON'; return; }

  const body = { model, messages, stream };
  const headers = { 'content-type': 'application/json' };

  if (!stream) {
    const r = await authFetch(api('/v1/chat/completions'), {
      method:'POST',
      headers,
      body: JSON.stringify(body)
    });
    const text = await r.text();
    try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
    catch { out.textContent = text; }
  } else {
    const r = await authFetch(api('/v1/chat/completions'), {
      method:'POST',
      headers,
      body: JSON.stringify(body)
    });
    const reader = r.body.getReader();
    const decoder = new TextDecoder();
    while (true) {
      const {value, done} = await reader.read();
      if (done) break;
      out.textContent += decoder.decode(value, {stream:true});
    }
  }
}

window.addEventListener('DOMContentLoaded', () => {
  // Check authentication first
  const password = getAuthPassword();
  if (!password) {
    window.location.href = '/login';
    return;
  }
  // Only load accounts if authenticated
  loadAccounts();
});
</script>
</body>
</html>